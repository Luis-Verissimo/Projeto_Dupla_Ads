name: Python DevSecOps Pipeline

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

permissions:
  contents: read

jobs:
  build_and_sast: # Renomeado para refletir a an√°lise SAST
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - name: Set up Python 3.10
      uses: actions/setup-python@v3
      with:
        python-version: "3.10"
    
    # --- Passo de Instala√ß√£o e SAST (Bandit) ---
    - name: Install dependencies and Bandit
      run: |
        python -m pip install --upgrade pip
        pip install flake8 pytest # Ferramentas originais
        pip install bandit         # Instala√ß√£o do Bandit para SAST
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
        
    - name: üö® Run SAST with Bandit
      run: |
        # Executa o Bandit no c√≥digo-fonte.
        # -r: recursivo | -ll: n√≠vel de severidade (HIGH/MEDIUM) | -o: arquivo de sa√≠da (SARIF)
        bandit -r . -f sarif -o bandit-results.sarif || true
      
    - name: Upload Bandit SAST results to GitHub Security tab
      uses: github/codeql-action/upload-sarif@v3 # Reutiliza a a√ß√£o do CodeQL para upload de SARIF
      with:
        sarif_file: bandit-results.sarif
      

    - name: Lint with flake8
      run: |
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
        flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics
        
    - name: Test with pytest
      run: |
        pytest

  
  dynamic_analysis:
    needs: build_and_sast
    runs-on: ubuntu-latest
    
    steps:
    - name: Deploy application to a Staging/Test environment
      run: echo "Simulating deployment to http://staging.myapp.com" 
    
    # --- Passo de An√°lise DAST (OWASP ZAP) ---
    - name: üåê Run DAST with OWASP ZAP Baseline Scan
      uses: zaproxy/action-baseline@v0.12.0
      with:
        # **IMPORTANTE:** Mude esta URL para o endere√ßo real do seu ambiente de teste!
        target: 'http://staging.myapp.com' 
        # Falha o job se encontrar alertas de risco ALTO ou M√âDIO
        fail_action: true
        allow_issue_writing: false